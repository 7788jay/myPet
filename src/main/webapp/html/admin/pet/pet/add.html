<!--样式区-->
<style>
    .ms-controller, .ms-important, [ms-controller], [ms-important] {
        visibility: hidden;
    }
</style>
<link rel="stylesheet" type="text/css" href="/libs/wangEditor/dist/css/wangEditor.css"/>
<link rel="stylesheet" type="text/css" href="/css/upload.css"/>
<link rel="stylesheet" type="text/css" href="/libs/webuploader/webuploader.css"/>

<!--标签区-->
<div id="addPet" ms-important="addPet">
    <div class="form">
        <form id="addForm">
            <div class=" user-edit ">
                <table class="table_1" cellpadding="0" cellspacing="0">
                    <tr>
                        <th width="10%"><span>*</span>宠物名称：</th>
                        <td width="23%"><input type="text" name="name"/></td>
                        <th width="10%"><span>*</span>物种：</th>
                        <td width="23%">
                            <select name="animalCode" ms-change="queryCategory" ms-duplex-string="animalCode">
                                <option ms-repeat="animals" ms-attr-value="el.code">{{el.name}}</option>
                            </select>
                        </td>
                        <th width="10%"><span>*</span> 宠物种类：</th>
                        <td width="23%">
                            <select name="categoryCode">
                                <option ms-repeat="categories" ms-attr-value="el.code">{{el.name}}</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th width="10%"><span>*</span>重量：</th>
                        <td width="23%"><input type="text" name="weight"/></td>
                        <th width="10%"><span>*</span>寿命：</th>
                        <td width="23%"><input type="text" name="life"/></td>
                        <th width="10%"><span>*</span>价格：</th>
                        <td width="23%"><input type="text" name="price"/></td>
                    </tr>
                    <tr>
                        <th width="10%"><span>*</span>图片：</th>
                        <td colspan="5" height="160px">
                            <input type="hidden" name="image" id="image" ms-attr-value="images"/>
                            <table class="upload_pic">
                                <tr>
                                    <td rowspan="2">
                                        <div id="uploaderImg" ms-repeat="images">
                                            <div class="file-panel"><a href="javascript:void(0)" ms-click="removeImg($index)"></a></div>
                                            <img style="margin-right: 5px;" width='130px' height='130px'
                                                 ms-attr-src="el"/>
                                        </div>
                                    </td>
                                    <td>
                                        <div type="file" id="picker" name="picker">选择图片</div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <div id="uploadProgress" class="progress pos-rel progress-striped active"
                                             data-percent="0%">
                                            <div class="progress-bar" style="width:0%;"></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <th width="10%"><span>*</span>描述：</th>
                        <td colspan="5">
                            <div style="height: 270px">
                                <textarea id="description" name="description" style="width: 95%;height: 270px;"/>
                            </div>
                        </td>
                    </tr>
                </table>
                <div class="user-btn">
                    <input type="button" value="保存" class="oper" ms-click="save"/>
                    <input type="button" value="返回" class="oper" ms-click="back"/>
                </div>
            </div>
        </form>
    </div>
</div>

<!--脚本区-->
<script type="text/javascript" src="/libs/webuploader/webuploader.js"/>
<script type="text/javascript">
    $(function () {
        var editor = new wangEditor('description');
        // 上传图片
        editor.config.uploadImgUrl = '/common/upload/editorImg';
        // 自定义菜单
        editor.config.menus = [
            'source',
            '|',
            'bold',
            'underline',
            'italic',
            'strikethrough',
            'eraser',
            'forecolor',
            'bgcolor',
            '|',
            'fontfamily',
            'fontsize',
            'head',
            'unorderlist',
            'orderlist',
            'alignleft',
            'aligncenter',
            'alignright',
            '|',
            'link',
            'unlink',
            'table',
            'emotion',
            '|',
            'img',
            'vedio',
            '|',
            'fullscreen'
        ];
        editor.create();
    });
</script>
<script type="text/javascript">
    var uploadLimit = 4;
    $(function () {
        var uploader = WebUploader.create({
            // swf文件路径
            swf: '/libs/webuploader/Uploader.swf',
            // 文件接收服务端。
            server: '/common/upload/img',
            //设置为 true 后，不需要手动调用上传，有文件选择即开始上传。
            auto: true,
            method: "POST",
            // 选择文件的按钮。可选。
            pick: '#picker',
            //验证文件总数量, 超出则不允许加入队列。
            fileNumLimit: 4,
            // 不压缩image, 默认如果是jpeg，文件上传前会压缩一把再上传！
            resize: false
        });
        // 当有文件添加进来的时候
        uploader.on('fileQueued', function (file) {
            $("#uploadProgress").attr("data-percent", "0%");
            $("#uploadProgress").find(".progress-bar").css("width", "0%");
        });
        // 文件上传成功，给item添加成功class, 用样式标记上传成功。
        uploader.on('uploadSuccess', function (file, res) {
            console.log(file);
            vm.images.push(res.msg);
        });
        // 文件上传过程中创建进度条实时显示。
        uploader.on('uploadProgress', function (file, percentage) {
            console.log(percentage)
            $("#uploadProgress").attr("data-percent", percentage*100+"%");
            $("#uploadProgress").find(".progress-bar").css("width", percentage*100+"%");
        });

        //表单校验
        var validator = $("#addForm").validate({
            rules: {
                name: {required: true},
                weight: {required: true,number:true},
                life: {required: true,number:true},
                price: {required: true,number:true}
            },
            messages: {
                name: {required: "必填"},
                weight: {required: "必填",number:"请填入数据"},
                life: {required: "必填",number:"请填入数据"},
                price: {required: "必填",number:"请填入数据"}
            },
            errorPlacement: errorPlacement,
            success: "valid"
        });

        var vm = avalon.define({
            $id: "addPet",
            animals: [],           //物种
            animalCode: "",   //物种code
            categories: [],            //种类
            images: [],                //图片
            currentDate: new Date(),
            //初始化
            init: function () {
                //获取动物种类
                $.ajax({
                    url: "/admin/pet/animal/queryAll",
                    type: "GET",
                    dataType: 'json',
                    success: function (result) {
                        vm.animals = result;
                        vm.animalCode = result[0].code;
                        vm.queryCategory();
                    }
                })
            },
            queryCategory:function(){
                $.ajax({
                    url: "/admin/pet/category/queryByAnimalCode?animalCode="+vm.animalCode,
                    type: "GET",
                    dataType: 'json',
                    success: function (result) {
                        vm.categories = result;
                    }
                })
            },
            //保存
            save: function () {
                if (validator.form()) {
                    $.ajax({
                        url: "/admin/pet/pet/add",
                        type: "POST",
                        dataType: 'json',
                        data: $("#addForm").serializeArray(),
                        success: function (result) {
                            if (result.success) {
                                PET_ADMIN.closeDialog();
                            }
                            layer.alert(result.msg);
                        }
                    });
                }
            },
            removeImg: function (index) {
                vm.images.removeAt(index);
                uploader.removeFile("WU_FILE_"+index);
            },
            back: function () {
                PET_ADMIN.cancelDialog();
            }
        });
        avalon.scan($("#addPet")[0], vm);
        vm.init();
    })
</script>