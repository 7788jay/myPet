<!--样式区-->
<style>
    .ms-controller, .ms-important, [ms-controller], [ms-important] {
        visibility: hidden;
    }
</style>

<!--标签区-->
<div id="addPet" ms-important="addPet">
    <div class="form">
        <form id="addForm">
            <div class=" user-edit ">
                <div class="remark"> 注：带 * 号为必填项</div>
                <table class="table_1" cellpadding="0" cellspacing="0">
                    <tr>
                        <th width="15%"><span>*</span>物种：</th>
                        <td width="35%"><input type="text"/></td>
                        <th width="15%"><span>*</span> 宠物种类：</th>
                        <td width="35%">
                            <select name="categoryCode">
                                <option ms-repeat="categories" ms-attr-value="el.code">{{el.name}}</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th width="15%"><span>*</span>宠物名称：</th>
                        <td width="35%"><input type="text" name="name"/></td>
                        <th width="15%"><span>*</span>重量：</th>
                        <td width="35%"><input type="text" name="weight"/></td>
                    </tr>
                    <tr>
                        <th width="15%"><span>*</span>寿命：</th>
                        <td width="35%"><input type="text" name="life"/></td>
                        <th width="15%"><span>*</span>价格：</th>
                        <td width="35%"><input type="text" name="price"/></td>
                    </tr>
                    <tr>
                        <th width="15%"><span>*</span>图片：</th>
                        <td width="35%" colspan="3">
                            <input type="hidden" name="icon" id="icon" value="/images/empty_icon.png"/>
                            <table class="upload_pic">
                                <tr>
                                    <td rowspan="2">
                                        <div id="img">
                                            <img style="margin-right: 5px;" width='130px' height='130px' ms-repeat="images" ms-attr-src="el"/>
                                        </div>
                                    </td>
                                    <td><input type="file" id="uploadify" name="uploadify"/></td>
                                </tr>
                                <tr>
                                    <td>
                                        <div id="uploadProgress" class="progress pos-rel progress-striped active" data-percent="0%">
                                            <div class="progress-bar" style="width:0%;"></div>
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <th width="15%"><span>*</span>描述：</th>
                        <td colspan="3"><textarea name="description"/></td>
                    </tr>
                </table>
                <div class="user-btn">
                    <input type="button" value="保存" class="oper" ms-click="save"/>
                    <input type="button" value="返回" class="oper" ms-click="back"/>
                </div>
            </div>
        </form>
    </div>
</div>

<!--脚本区-->
<script type="text/javascript">
    $(function () {
        $("#uploadify").uploadify({
            height: 25,
            swf: '/libs/uploadify/uploadify.swf',
            uploader: '/common/upload/img',
            fileTypeExts: '*.png;*.jpg;*.jpeg;*.gif;*.bmp',
            queueID: 'queue',
            fileObjName: 'file',
            method: 'post',
            auto: true,
            itemTemplate: false,
            buttonText: '选择图片',
            multi: true,
            uploadLimit: 4,
            fileSizeLimit: '1MB',
            overrideEvents: ['onDialogClose','onSelectError','onUploadProgress','onUploadError'],
            removeCompleted: 'true',
            onUploadStart: function (file) {
                console.log(1);
                $("#uploadProgress").attr("data-percent", "0%");
                $("#uploadProgress").find(".progress-bar").css("width", "0%");
            },
            onUploadProgress: function (file, bytesUploaded, bytesTotal, totalBytesUploaded, totalBytesTotal) {
                avalon.log(2, bytesUploaded, bytesTotal, totalBytesUploaded, totalBytesTotal);
                var precent = (totalBytesUploaded / totalBytesTotal * 100).toFixed(0) + "%";
                $("#uploadProgress").attr("data-percent", precent);
                $("#uploadProgress").find(".progress-bar").css("width", precent);
            },
            onUploadSuccess: function (file, data, response) {
                var jsonData = JSON.parse(data);
                console.log(jsonData);
                if (jsonData.success) {
                    vm.images.push(jsonData.msg);
//                    $("#showImage").attr("src", jsonData.msg);
//                    $("#icon").val(jsonData.msg);
                } else {
                    layer.alert("上传失败！");
                }
            },
            onSelectError: function (file, errorCode, errorMsg) {
                switch (errorCode) {
                    case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT:
                        layer.alert("图标大小不能超过1MB");
                        break;
                    case SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED:
                        layer.alert("图片数量超过限制！");
                        break;
                    default :
                        layer.alert("图标文件读取失败");
                        break;
                }
                return false;
            },
            onUploadError: function (file, errorCode, errorMsg) {
                switch (errorCode) {
                    case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED:
                        layer.alert("图片数量超过限制！");
                        break;
                    default :
                        layer.alert("图标文件读取失败");
                        break;
                }
                return false;
            }
        });

        //表单校验
        var validator = $("#addForm").validate({
            rules: {
                userName: {required: true},
                password: {required: true, isURL: true}
            },
            messages: {
                userName: {required: "必选"},
                password: {required: "必填"}
            },
            errorPlacement: errorPlacement,
            success: "valid"
        });

        var vm = avalon.define({
            $id: "addPet",
            categories: [],            //种类
            images: [],                //图片
            currentDate: new Date(),
            //初始化
            init: function(){
                $.ajax({
                    url: "/admin/pet/category/queryAll",
                    type: "GET",
                    dataType: 'json',
                    success: function (result) {
                        vm.categories = result;
                    }
                })
            },
            //保存
            save: function () {
                if (validator.form()) {
                    $.ajax({
                        url: "/admin/pet/pet/add",
                        type: "POST",
                        dataType: 'json',
                        data: $("#addForm").serializeArray(),
                        success: function (result) {
                            if(result.success){
                                PET_ADMIN.closeDialog();
                            }
                            layer.alert(result.msg);
                        }
                    });
                }
            },
            back: function () {
                PET_ADMIN.cancelDialog();
            }
        });
        avalon.scan($("#addPet")[0], vm);
        vm.init();
    })
</script>